
-- Requirement 1
-- Retrieve the details of all apartments in a specific building, sorted by apartment type.
SELECT A.ApartNum, A.ApartType, B.Name AS BuildingName, B.Address
FROM Apartment AS A JOIN Building AS B
ON A.BuildingID = B.BuildingID
WHERE A.BuildingID = 1
ORDER BY A.ApartType;

-- Requirement 2
-- Find all available apartments (not booked during a given date range).
SELECT A.ApartID, A.ApartNum, A.ApartType, BD.Name AS BuildingName, BD.Address
FROM Apartment AS A
JOIN Building AS BD ON A.BuildingID = BD.BuildingID
WHERE A.ApartID NOT IN (
	SELECT BK.ApartID
	FROM Booking AS BK
	WHERE ('2024-12-03' BETWEEN BK.DateStart AND BK.DateEnd
	OR '2024-12-05' BETWEEN BK.DateStart AND BK.DateEnd
	OR BK.DateStart BETWEEN '2024-12-03' AND '2024-12-05')
);


-- Requirement 3
-- List the buildings with the highest number of booked apartments.
SELECT B.BuildingID, B.Name AS BuildingName, B.Address, COUNT(DISTINCT Bk.BookID) AS BookedApartments
FROM Booking AS Bk
JOIN Apartment AS A ON Bk.ApartID = A.ApartID
JOIN Building AS B ON A.BuildingID = B.BuildingID
GROUP BY B.BuildingID, B.Name, B.Address
ORDER BY BookedApartments DESC;

-- Requirement 4 
-- Retrieve the total revenue generated by each building from bookings.
SELECT b.BuildingID, b.Name, SUM(DATEDIFF(bo.DateEnd , bo.DateStart) * 100) AS TotalRevenue
FROM Building b
JOIN Apartment a ON b.BuildingID = a.BuildingID
JOIN Booking bo ON a.ApartID = bo.ApartID
GROUP BY b.BuildingID, b.Name
ORDER BY TotalRevenue DESC;

-- Requirement 5
-- Find guests who have made more than 2 bookings.
SELECT G.GuestID, G.FirstName, G.LastName, COUNT(Bk.BookID) AS BookingCount
FROM Guest AS G
JOIN Booking AS Bk ON G.GuestID = Bk.GuestID
GROUP BY G.GuestID, G.FirstName, G.LastName
HAVING BookingCount > 2;


-- Requirement 6
-- List all bookings that are currently active (ongoing based on the current date).
SELECT BK.BookID, A.ApartNum, A.ApartType, BD.Name, BD.Address
FROM Booking AS BK
JOIN Apartment AS A ON BK.ApartID = A.ApartID
JOIN Building AS BD ON A.BuildingID = BD.BuildingID
WHERE '2024-12-03' BETWEEN BK.DateStart AND BK.DateEnd;

-- Requirement 7
-- Generate a report showing booking details (apartment, guest name, booking status) for a specific date range.
SELECT 
    A.ApartNum, 
    CONCAT(G.FirstName, ' ', G.LastName) AS GuestName, 
    CASE 
        WHEN '2024-12-03' BETWEEN BK.DateStart AND BK.DateEnd THEN 'Booked'
        ELSE 'Available'
    END AS BookingStatus
FROM Apartment AS A
JOIN Booking AS BK ON A.ApartID = BK.ApartID
JOIN Guest AS G ON BK.GuestID = G.GuestID;   
